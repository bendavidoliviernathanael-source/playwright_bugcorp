# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Initiation √† la l'int√©gration continue CI (playwright)

# d√©termine quand le script est d√©clench√©
on:
  push:
    branches: ["test-CI2"]
  pull_request:
    branches: ["test-CI2"]

# les t√¢ches √† ex√©cuter
jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # strategy:
    #   matrix:
    #    node-version: [18.x, 20.x, 22.x]
    # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
      #le job t√©l√©charge ton repo sur la machine de la CI.
      - name: R√©cup√©rer le code
        uses: actions/checkout@v4

      - name: Configurer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Installer les d√©pendances
        run: npm ci

      # - run: npm run build --if-present

      # - run: npm test
      - name: Installer les navigateurs Playwright (avec d√©pendances OS)
        run: npx playwright install --with-deps
      - name: Attendre que l'application soit pr√™te
        run: |
          URL="https://bugcorp.vercel.app"
          echo "Attente de $URL ..."
          for i in {1..60}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
            if [ "$code" = "200" ]; then
              echo "OK (HTTP 200) ‚úÖ"
              exit 0
            fi
            echo "Pas pr√™te encore (HTTP $code). nouvelle tentative dans 5s..."
            sleep 5
          done
          echo "D√©lai d'expiration en attente de $URL ‚ùå"
          exit 1

      - name: Ex√©cuter les tests Playwright
        env:
          CI: true
          BASE_URL: https://bugcorp.vercel.app
        run: npx playwright test

      - name: T√©l√©charger le rapport HTML Playwright
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          retention-days: 14

      - name: T√©l√©charger les r√©sultats des tests Playwright (JUnit + traces + vid√©os + captures d'√©cran)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results
          retention-days: 14

  discord:
    runs-on: ubuntu-latest
    steps:
      - name: Download Playwright report artifact
        uses: actions/download-artifact@v4
        with:
          name: playwright-report.zip
          path: .

      - name: Send Playwright report to Discord
        if: always() # Envoie m√™me si les tests ont √©chou√©
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -X POST \
           -F "payload_json={\"content\":\"üìä Rapport Playwright pour **${GITHUB_REPOSITORY}** (branch: **${GITHUB_REF_NAME}**) ‚Äî commit: ${GITHUB_SHA}\"}" \
           -F "file=@playwright-report.zip" \
           "$DISCORD_WEBHOOK_URL"
